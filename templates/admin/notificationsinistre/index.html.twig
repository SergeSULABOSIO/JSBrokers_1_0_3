<div 
    data-controller = "rubrique" 
    data-rubrique-nom-value = "Notification Sinistre"
    class="d-flex flex-column h-100"
>
    <div 
        id = "liste" 
        class="flex-grow-1 d-flex flex-column" 
        data-controller="dialogue liste-principale" 
        data-liste-principale-identreprise-value={{entreprise.id}} 
        data-liste-principale-idutilisateur-value={{utilisateur.id}} 
        data-liste-principale-nbelements-value={{notificationsinistres|length}} 
        data-liste-principale-rubrique-value="Notification Sinistre" 
        data-liste-principale-entite-value="NotificationSinistre" 
        data-liste-principale-controleurphp-value="notificationsinistre" 
        data-liste-principale-controleurstimulus-value="notificationsinistre-formulaire" 
        {# data-liste-principale-controleurstimulusformulaire-value="notificationsinistre-formulaire"  #}
    >
        {# Ce conteneur va aussi utiliser flexbox et cacher tout débordement #}
        <div class="shadow-sm sensible bg-white d-flex flex-column flex-grow-1" style="overflow: hidden;">
            {# Les barres d'outils ne grandissent pas #}
            <div class="flex-shrink-0">
                {# Barre d'outils #} 
                {{ include("components/_liste_barre_outils.html.twig") }}
                {# Barre de Recherche #}
                {{ component('_search_bar') }}
                {# Barre des totaux #}
                {{ include('components/_totals_bar.html.twig') }}
            </div>

            {# NOUVEAU : Un wrapper pour le tableau qui gère le défilement #}
            <div class="table-scroll-wrapper flex-grow-1">
                {# Tableau #}
                <table class="table table-hover table-sm caption-top p-3 table-enhanced">
                    <caption>
                        <span data-liste-principale-target = "display">
                            {% if notificationsinistres|length == 0 %}
                                {{ "list_filter_result_empty" | trans}}
                            {% else %}
                                {{ "list_filter_result_elements" | trans({
                                    ':number': notificationsinistres|length
                                })}}
                            {% endif %}
                        </span>
                        <div class="d-flex gap-1">
                            {{ knp_pagination_render(notificationsinistres) }}
                        </div>
                    </caption>
                    {% if notificationsinistres|length != 0 %}
                        {# MODIFICATION : On ajoute une classe pour rendre l'en-tête collant #}
                        <thead class="table-light sticky-header">
                            <tr class="text-center">
                                {# ============================================================ #}
                                {# DÉBUT MODIFICATION : EN-TÊTES DE COLONNES DYNAMIQUES        #}
                                {# ============================================================ #}

                                {# Colonne 1 : Statique pour la case à cocher et l'ID #}
                                <th scope="col" style="width: 80px;">
                                    <div class="form-check m-2 justify-content-start">
                                        <input 
                                            class="form-check-input" 
                                            value="" 
                                            type="checkbox" 
                                            id="myCheckbox" 
                                            data-action="change->liste-principale#handleItemToutCocher" 
                                            data-liste-principale-target="selectAllCheckbox"
                                        >
                                        <label 
                                            for="myCheckbox"
                                            class="text-secondary" 
                                        >
                                            Id.  
                                        </label>
                                    </div>
                                </th>
                                
                                {# Colonne 2 : Titre de la colonne principale depuis ListeCanvas #}
                                {% if listeCanvas.colonne_principale is defined %}
                                    <th scope="col">
                                        <div class='d-flex justify-content-start text-secondary m-2'>
                                            {{ listeCanvas.colonne_principale.titre_colonne | default('Titre principal') }}
                                        </div>
                                    </th>
                                {% endif %}

                                {# Colonnes suivantes : Titres des colonnes numériques depuis ListeCanvas #}
                                {% if listeCanvas.colonnes_numeriques is defined %}
                                    {% for colonne in listeCanvas.colonnes_numeriques %}
                                        <th scope="col" style="width:150px"> {# Largeur fixe pour l'alignement #}
                                            <div class='d-flex justify-content-end text-secondary m-2'>
                                                {{ colonne.titre_colonne | default('Valeur') }}
                                            </div>
                                        </th>
                                    {% endfor %}
                                {% endif %}

                                {# ============================================================ #}
                                {# FIN MODIFICATION : EN-TÊTES DE COLONNES DYNAMIQUES           #}
                                {# ============================================================ #}
                            </tr>
                        </thead>

                        {# CONTENU DU TABLEAU #}
                        <tbody class="table-group-divider context-target" data-liste-principale-target = "donnees">
                            <div 
                                data-controller="donnees"
                                {# J'envoie l'objet status vers le controleur stimulus: comme c'est un objet, il faut le décorer avec |json_encode #}
                                data-donnees-status-value='{{ status|json_encode }}' 
                                data-donnees-page-value={{ page }}
                                data-donnees-limit-value={{ limit }}
                                data-donnees-totalitems-value={{ totalItems }}
                            ></div>
                            {% if notificationsinistres|length == 0 %}
                                <tr>
                                    <td class="p-3 m-2" style="width:80px"></td>
                                    <td class="p-2">Aucune information trouvée!</td>
                                    <td></td>
                                </tr>
                            {% else %}
                                {# Boucler les donnees #}
                                {% for entity in notificationsinistres %}
                                    {# ================================================================= #}
                                    {# DÉBUT MODIFICATION : LIGNES ET CELLULES DU TABLEAU DYNAMIQUES   #}
                                    {# ================================================================= #}
                                    <tr
                                        id="liste_row_{{ entity.id }}"
                                        data-controller="liste-element"
                                        data-liste-element-is-shown-value="false"
                                        data-liste-element-idobjet-value="{{ entity.id }}"
                                        class="element-a-encadrer parent-a-options context-target align-middle"
                                        
                                        {# Boucle pour les attributs numériques (inchangée) #}
                                        {% for key, value in constante.getNumericValues(entity) %}
                                            data-{{ key }}-value="{{ value }}"
                                        {% endfor %}
                                        
                                        {# Actions existantes #}
                                        data-action="
                                            click->liste-principale#toggleRowSelection
                                            dblclick->liste-element#dispatchDoubleClick
                                        "
                                        {# On passe l'objet entier au contrôleur Stimulus pour l'événement double-clic #}
                                        {# data-liste-element-objet-value='{{ entity | serialize('json') | e('html_attr') }}' #}
                                        data-liste-element-objet-value='{{ entity|json_encode }}'
                                    >
                                        {# Colonne 1 : Statique (Case à cocher et ID) #}
                                        <td class="p-3 m-2" style="width:80px">
                                            <div class="form-group">
                                                <input
                                                    type="checkbox"
                                                    id="check_{{ entity.id }}"
                                                    name="check_[]"
                                                    value="selectionnee"
                                                    class="form-check-input"
                                                    data-action="change->liste-principale#handleCheckboxChange"
                                                    data-liste-principale-target="rowCheckbox"
                                                    data-idobjet-value="{{ entity.id }}"
                                                >
                                                <label for="check_{{ entity.id }}" class="text-secondary">
                                                    {{ entity.id }}
                                                </label>
                                            </div>
                                        </td>

                                        {# Colonne 2 : Cellule principale dynamique #}
                                        <td class="p-2">
                                            {% set col_principale = listeCanvas.colonne_principale %}

                                            {# Ligne 1: Texte principal #}
                                            <div style="font-weight: bold; color: #0047AB;"> {# Bleu cobalt #}
                                                {# Icône #}
                                                {% if col_principale.texte_principal.icone is defined %}
                                                    <twig:UX:Icon name="{{ col_principale.texte_principal.icone }}" style="width: {{ col_principale.texte_principal.icone_taille }}; height: {{ col_principale.texte_principal.icone_taille }};" />
                                                {% endif %}

                                                {# --- MODIFICATION ICI --- #}
                                                {# Ajout de la logique de troncature pour le texte principal #}

                                                {# Préfixe et Texte#}
                                                {{ col_principale.texte_principal.attribut_prefixe }}

                                                {# Valeur formatée et tronquée si nécessaire #}
                                                {% set texte_principal = col_principale.texte_principal %}
                                                {% set valeur_principale = attribute(entity, texte_principal.attribut_code) %}
                                                
                                                {% if texte_principal.attribut_taille_max is defined and texte_principal.attribut_taille_max is not null and valeur_principale|length > texte_principal.attribut_taille_max %}
                                                    "{{ valeur_principale|slice(0, texte_principal.attribut_taille_max) ~ '...' }}"
                                                {% else %}
                                                    "{{ valeur_principale }}"
                                                {% endif %}
                                            </div>

                                            {# Ligne 2: Textes secondaires #}
                                            <small class="text-secondary d-flex align-items-center mt-1">
                                                {% for texte in col_principale.textes_secondaires %}
                                                    <span class="d-inline-flex align-items-center">
                                                        {# Icône #}
                                                        {% if texte.icone is defined %}
                                                            <twig:UX:Icon name="{{ texte.icone }}" style="width: {{ texte.icone_taille }}; height: {{ texte.icone_taille }}; margin-right: 4px;" />
                                                        {% endif %}

                                                        {# Préfixe #}
                                                        {{ texte.attribut_prefixe }}

                                                        {# Valeur formatée #}
                                                        {% set valeur = attribute(entity, texte.attribut_code) %}
                                                        
                                                        {% if texte.attribut_type == 'date' and valeur is not null %}
                                                            {{ valeur|date('d/m/Y') }}
                                                        {% elseif texte.attribut_type == 'text' and texte.attribut_taille_max is not null and valeur|length > texte.attribut_taille_max %}
                                                            {{ valeur|slice(0, texte.attribut_taille_max) ~ '...' }}
                                                        {% else %}
                                                            {{ valeur }}
                                                        {% endif %}
                                                    </span>
                                                    {# Séparateur #}
                                                    {% if not loop.last %}
                                                        <span class="mx-2">{{ col_principale.textes_secondaires_separateurs | raw }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </small>
                                        </td>

                                        {# Colonnes suivantes : Cellules numériques dynamiques #}
                                        {% for colonne in listeCanvas.colonnes_numeriques %}
                                            <td class="text-end" style="font-weight: bold; color: #495057;"> {# Gris foncé #}
                                                {% set valeur_numerique = attribute(entity, colonne.attribut_code) %}
                                                {{ colonne.attribut_unité }} {{ valeur_numerique | number_format(2, ',', ' ') }}
                                            </td>
                                        {% endfor %}

                                    </tr>
                                    {# ================================================================= #}
                                    {# FIN MODIFICATION : LIGNES ET CELLULES DU TABLEAU DYNAMIQUES     #}
                                    {# ================================================================= #}
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    {% endif %}
                </table>
            </div>
        </div>
        {{ include('components/_menu_contextuel.html.twig') }}
        {{ include('components/_dialogue.html.twig') }}
    </div>
</div>