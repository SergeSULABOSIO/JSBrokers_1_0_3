{# templates/admin/notificationsinistre/_form.html.twig #}

{# On crée une "map" des champs pour retrouver facilement leur configuration par leur "code" #}
{% set champs_map = {} %}
{% for champ in entityFormCanvas.liste %}
    {% set champs_map = champs_map|merge({ (champ.code): champ }) %}
{% endfor %}

{{ form_start(form) }}
    
    {# On utilise la structure de layout si elle est définie #}
    {% if entityFormCanvas.parametres.form_layout is defined and entityFormCanvas.parametres.form_layout is not empty %}
        
        {% for row in entityFormCanvas.parametres.form_layout %}
            <div class="row gx-3">
                {% set col_class = 'col-md-' ~ (12 / row.colonnes|length)|round(0, 'floor') %}
                {% for col in row.colonnes %}
                    <div class="{{ col_class }}">
                        {% for field_code in col.champs %}
                            {% if form[field_code] is defined %}
                                {# On récupère la configuration complète du champ depuis notre map #}
                                {% set field_config = champs_map[field_code] ?? null %}
                                
                                <div class="mb-3">
                                    {# 1. On affiche le label du champ #}
                                    {{ form_label(form[field_code], field_config.intitule|default(null)) }}
                                    
                                    {# 2. On crée un conteneur pour l'icône et le champ #}
                                    <div class="form-input-with-icon">
                                        {# On affiche l'icône si elle est définie dans le canvas #}
                                        {% if field_config and field_config.icone is defined and field_config.icone %}
                                            {{ ux_icon(field_config.icone, { class: 'input-icon' }) }}
                                        {% endif %}
                                        
                                        {# On affiche le champ lui-même (input, select, etc.) #}
                                        {{ form_widget(form[field_code]) }}
                                    </div>
                                    
                                    {# 3. On affiche les erreurs de validation #}
                                    <div class="form-text text-danger">{{ form_errors(form[field_code]) }}</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

    {% else %}
        {{ form_widget(form) }}
    {% endif %}

    {{ form_rest(form) }}

{{ form_end(form) }}