{# templates/themes/_collection_widget.html.twig #}
{% block collection_widget %}
    {# On récupère les options passées par form_row() #}
    {% set manager_options = manager_options|default({}) %}

    {# On récupère l'état 'disabled' depuis les options #}
    {% set isDisabled = manager_options.disabled|default(false) %}
    
    {# --- CORRECTION : On affiche toujours le widget, mais on lui ajoute une classe 'is-disabled' en mode création --- #}
    <div 
        {{ stimulus_controller('collection', manager_options) }} 
        class="collection-manager-accordion {{ isDisabled ? 'is-disabled' : '' }}"
        id="collection-{{ id }}"
        data-collection-id-entreprise-value="{{ idEntreprise }}"
        data-collection-id-invite-value="{{ idInvite }}"
    >
        {# TITRE DE L'ACCORDÉON #}
        <div class="accordion-title"
             data-action="
                click->collection#toggleAccordion
                mouseenter->collection#logMouseEnter
                mouseleave->collection#logMouseLeave
             "
        >
            {# NOUVEAU: Conteneur pour l'état de chargement, initialement caché #}
            <div class="title-left-block-loading" data-collection-target="titleLoading" style="display: none; align-items: center;">
                <span class="toggle-icon"></span> {# Espace réservé pour l'alignement avec le titre normal #}
                <span class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></span>
                <span class="loading-text fw-normal">Chargement de {{ form.vars.label|default(form.vars.name) }}...</span>
            </div>

            {# Conteneur pour le titre normal, qui sera caché pendant le chargement #}
            <div class="title-left-block" data-collection-target="titleContent">
                <span class="toggle-icon">+</span>
                {% if manager_options.totalizableField is defined and manager_options.totalValue is defined %}
                    <strong class="collection-total-value text-primary"
                            data-action="mouseenter->collection#showTooltip mouseleave->collection#hideTooltip"
                            data-tooltip-text-value="Total {{ manager_options.totalizableField|replace({'_': ' '})|title }}"
                            data-collection-target="totalValueDisplay">
                        {{ manager_options.totalValue|number_format(2, ',', ' ') }} {{ manager_options.totalUnit|default('') }}
                    </strong>
                {% endif %}
                <strong class="field-label">{{ form.vars.label|default(form.vars.name) }}</strong>
                {% if form.vars.help %}<span class="form-text text-muted">({{ form.vars.help }})</span>{% endif %}
                <span class="badge bg-primary" data-collection-target="countBadge" style="display: none;">0</span>
            </div>

            {# --- CORRECTION : On rend toujours le bouton, mais on le cache avec une classe si désactivé --- #}
            <div class="title-right-block {{ isDisabled ? 'd-none' : '' }}" data-collection-target="addButtonContainer">
                <button type="button" class="btn btn-sm btn-primary" data-action="click->collection#addItem">
                    <twig:UX:Icon name="gridicons:add" style="width: 23px;" />
                    <span>Ajouter </span>
                </button>
            </div>
        </div>

        {# CONTENU DE L'ACCORDÉON (la liste) #}
        <div class="accordion-content" data-collection-target="contentPanel">
            <div class="list-container" data-collection-target="listContainer">
                {# La liste des contacts sera chargée ici via AJAX #}
                <div class="text-center"><span class="spinner-border"></span> Chargement...</div>
            </div>
        </div>
    </div>

    {# On cache le rendu par défaut de Symfony #}
    <div style="display:none;">
        {{- form_widget(form) -}}
    </div>
{% endblock %}