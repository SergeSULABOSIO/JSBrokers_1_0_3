{#
    Ce template est un composant générique et réutilisable pour afficher une liste d'entités sous forme de tableau.
    Il est le conteneur principal qui orchestre l'affichage des en-têtes, des données et de l'état vide.

    Contrôleur Stimulus associé :
    - `list-manager` (anciennement `liste-principale`): Gère l'ensemble de la liste, y compris la sélection, le tri,
      la pagination (via des événements) et les actions globales comme "tout cocher" ou "ajouter".

    Paramètres attendus :
    - `data`: La collection d'entités à afficher.
    - `entite_nom`: Le nom de l'entité (ex: "Client", "Piste").
    - `entityFormCanvas`: La configuration du formulaire de l'entité, utilisée pour les actions d'ajout/édition.
    - `listeCanvas`: La configuration d'affichage de la liste (colonnes, titres).
    - `numericAttributes` (optionnel): Attributs numériques pour les totaux.
#}
<div 
        id="{{ listId | default('list-controller-' ~ random()) }}" {# CORRECTION : Utiliser un ID prédictible ou un fallback aléatoire. #}
        data-controller="list-manager" 
        data-list-manager-nbelements-value="{{ data|length }}" 
        data-list-manager-entite-value="{{ entite_nom }}" 
        data-list-manager-server-root-name-value="{{ serverRootName }}" 
        data-list-manager-id-entreprise-value="{{ idEntreprise }}" 
        data-list-manager-id-invite-value="{{ idInvite }}"  
        data-list-manager-entity-form-canvas-value='{{ entityFormCanvas|json_encode|e('html_attr') }}' 
        data-list-manager-numeric-attributes-and-values-value='{{ numericAttributesAndValues|default({})|json_encode|e('html_attr') }}'
        data-list-manager-list-url-value="{{ listUrl | default('') }}" {# CORRECTION : Ajout de l'URL unique pour la persistance #}
    > 
        <div class="table-scroll-wrapper flex-grow-1" data-list-manager-target="listContainer">
            <table class="table table-hover table-sm table-enhanced">
                <thead class="table-light sticky-header">
                    <tr class="text-center">
                        <th scope="col" style="width: 80px;">
                            <div class="form-check m-2 justify-content-start">
                                <input class="form-check-input" type="checkbox" data-action="change->list-manager#toggleAll" data-list-manager-target="selectAllCheckbox">
                                <label class="text-secondary">Id.</label>
                            </div>
                        </th>
                        {% if listeCanvas.colonne_principale is defined %}
                            <th scope="col">
                                <div class='d-flex justify-content-start text-secondary m-2'>{{ listeCanvas.colonne_principale.titre_colonne | default('Titre principal') }}</div>
                            </th>
                        {% endif %}
                        {# On n'affiche les colonnes numériques que si on n'est PAS dans une collection totalisable de dialogue #}
                        {% if not (usage is defined and usage == 'dialog' and totalizableField is defined and totalizableField is not null) %}
                            {% for colonne in listeCanvas.colonnes_numeriques | default([]) %}
                                <th scope="col" style="width:150px" class="th-numeric">
                                    <div class='text-secondary m-2'>{{ colonne.titre_colonne | default('Valeur') }}</div>
                                </th>
                            {% endfor %}
                        {% endif %}
                        {# NOUVEAU : Colonne d'actions pour les collections dans un dialogue #}
                        {% if usage is defined and usage == 'dialog' %}
                            <th scope="col" style="width: 100px;" class="text-end pe-4">
                                <div class='d-flex justify-content-end text-secondary m-2'>Actions</div>
                            </th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="table-group-divider context-target" data-list-manager-target="donnees">
                    {# MODIFICATION : On rend les lignes directement côté serveur si des données sont passées.
                       Le contrôleur JS ne chargera les données que lors d'une recherche/refresh. #}
                    {% for entity in data %}
                        {{ include('components/_list_row.html.twig', { 
                            'entity': entity, 
                            'listeCanvas': listeCanvas, 
                            'entite_nom': entite_nom, 
                            'entityCanvas': entityCanvas, 
                            'usage': usage|default('generic'),
                            'parentEntity': parentEntity|default(null), 
                            'totalizableField': totalizableField|default(null), 
                            'totalizableFieldDetails': totalizableFieldDetails|default(null)
                        }) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div data-list-manager-target="emptyStateContainer" class="d-none h-100">
            {% if usage is defined and usage == 'dialog' %}
                {# CAS : État vide pour une collection DANS UN FORMULAIRE D'ÉDITION. #}
                {% set emptyStateParams = {
                    title: "La collection est vide",
                    description: "Ajouter un élément à la collection en cliquant sur le bouton \"Ajouter\".",
                    icon_name: entityCanvas.parametres.icone | default('lucide:folder-plus'),
                    button_text: "Ajouter",
                    button_action: customAddAction, 
                    button_icon: "lucide:plus-circle"
                } %}
            {% else %}
                {# CAS : État vide pour une liste principale OU une collection contextuelle (hors formulaire). #}
                {% set emptyStateParams = {
                    title: "Aucun élément trouvé",
                    description: "Essayez de réinitialiser vos critères ou d'ajouter un nouvel élément.",
                    icon_name: entityCanvas.parametres.icone | default('lucide:search-x'),
                    button_2_text: "Réinitialiser",
                    button_2_action: "click->list-manager#resetSearch",
                    button_2_icon: "lucide:rotate-cw"
                } %}
                {% if can_add | default(false) %}
                    {% set emptyStateParams = emptyStateParams|merge({ button_text: "Ajouter", button_action: "click->list-manager#requestAddItem", button_icon: "lucide:plus-circle" }) %}
                {% endif %}
            {% endif %}

            {{ include('components/_empty_state.html.twig', emptyStateParams) }}
        </div>
    </div>
</div>
