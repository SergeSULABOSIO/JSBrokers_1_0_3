{#
    Ce template représente une seule ligne (`<tr>`) dans un tableau de liste.
    Il est le conteneur pour les cellules de la ligne et est piloté par son propre contrôleur Stimulus.

    Contrôleur Stimulus associé :
    - `list-row` (anciennement `list-element`): Gère les interactions spécifiques à cette ligne,
      comme la sélection (clic), le double-clic pour ouvrir les détails, et la gestion de l'état de la case à cocher.
      Il communique avec le contrôleur parent `list-manager` pour synchroniser l'état de sélection global.

    Paramètres attendus :
    - `entity`: L'objet de données pour cette ligne.
    - `listeCanvas`: La configuration d'affichage de la liste.
    - `entityCanvas`: La configuration du formulaire de l'entité.
#}
<tr
    id="liste_row_{{ entity.id }}"
    data-controller="list-row"
    data-id="{{ entity.id }}"
    data-item-id="{{ entity.id }}" {# NOUVEAU : Ajout pour le comptage dans collection_controller #}
    data-list-row-idobjet-value="{{ entity.id }}"
    class="element-a-encadrer parent-a-options context-target align-middle"
    data-action="
        click->list-row#toggleSelection
        {% if usage is defined and usage == 'dialog' %}
            mouseenter->collection#showRowActions
            mouseleave->collection#hideRowActions
        {% endif %}
    "
>
    {# Colonne 1 : Statique (Case à cocher et ID) #}
    <td class="p-3 m-2" style="width:80px">
        <div class="form-group">
            {% set serialization_context = {
                'groups': 'list:read',
                'enable_max_depth': true
            } %}
            <input
                type="checkbox"
                id="check_{{ entity.id }}"
                name="check_[]"
                value="selectionnee"
                class="form-check-input"
                data-list-manager-target="rowCheckbox" {# Cible pour le contrôleur de liste (tout cocher) #}
                data-list-row-target="checkbox" {# Cible pour le contrôleur de ligne #}
                data-action="change->list-manager#handleRowSelection" {# NOUVEAU : Notifie le parent list-manager #}
                data-list-row-idobjet-value="{{ entity.id }}" {# CORRECTION: Utiliser le bon nom d'attribut pour l'ID #}
                {# On passe l'objet entier au contrôleur Stimulus pour l'événement double-clic #}
                data-entity-type="{{entite_nom}}" 
                data-entity='{{ entity|serialize('json', serialization_context)|e('html_attr') }}' 
                data-canvas='{{ entityCanvas|json_encode|e('html_attr') }}' 
            >
            <label for="check_{{ entity.id }}" class="text-secondary">
                {{ entity.id }}
            </label>
        </div>
    </td>

    {# Colonne 2 : Cellule principale dynamique #}
    <td class="p-2" data-controller="responsive-cell">
        {% set col_principale = listeCanvas.colonne_principale %}

        {# Ligne 1: Texte principal #}
        <div style="font-weight: bold; color: #0047AB;"> {# Bleu cobalt #}
            {# Icône #}
            {# CORRECTION : L'icône doit provenir du canvas de l'entité elle-même (entityCanvas) pour être correcte dans les collections. #}
            {% set icon_name = entityCanvas.parametres.icone|default(null) %}
            {% if icon_name %}
                <twig:UX:Icon name="{{ resolve_icon_name(icon_name) }}" style="width: {{ col_principale.texte_principal.icone_taille | default('1.3em') }}; height: {{ col_principale.texte_principal.icone_taille | default('1.3em') }}; margin-right: 4px;" />
            {% endif %}

            {# Préfixe et Texte#}
            {{ col_principale.texte_principal.attribut_prefixe | default('') }}

            {# Valeur formatée et tronquée si nécessaire #}
            {% set texte_principal = col_principale.texte_principal %}
            {% set valeur_principale = attribute(entity, texte_principal.attribut_code) %}
            
            {% if texte_principal.attribut_taille_max is defined and texte_principal.attribut_taille_max is not null and valeur_principale|length > texte_principal.attribut_taille_max %}
                "{{ valeur_principale|slice(0, texte_principal.attribut_taille_max) ~ '...' }}"
            {% else %}
                "{{ valeur_principale }}"
            {% endif %}
        </div>

        {# Ligne 2: Textes secondaires #}
        <small class="text-secondary d-flex align-items-center mt-1" data-responsive-cell-target="secondaryInfo">
            {# CORRECTION : La logique d'affichage est maintenant conditionnelle pour éviter les régressions. #}
            {% if usage is defined and usage == 'dialog' and totalizableField is defined and totalizableField is not null %}
                {# CAS 1 : Collection totalisable dans une boîte de dialogue. On utilise le nouveau rendu. #}
                {% include 'components/collection/_list_item_secondary_line.html.twig' with {
                    'item': entity,
                    'parentEntity': parentEntity|default(null),
                    'totalizableField': totalizableField,
                    'totalizableFieldDetails': totalizableFieldDetails
                } %}
            {% elseif usage is defined and usage == 'dialog' %}
                {# CAS 2 : Collection NON totalisable dans une boîte de dialogue. On utilise l'ancien affichage simplifié. #}
                {% set first_secondary_displayed = false %}
                {% for texte in col_principale.textes_secondaires %}
                    {% set valeur = attribute(entity, texte.attribut_code) %}
                    {% if not first_secondary_displayed and valeur is not null and valeur is not empty %}
                        <span class="d-inline-flex align-items-center">
                            {% if texte.icone is defined %}<twig:UX:Icon name="{{ resolve_icon_name(texte.icone) }}" style="width: {{ texte.icone_taille | default('1.1em') }}; height: {{ texte.icone_taille | default('1.1em') }}; margin-right: 4px;" />{% endif %}
                            {{ texte.attribut_prefixe | default('') }}
                            {% if texte.attribut_type|default('') == 'date' and valeur is not null %}{{ valeur|date('d/m/Y') }}{% else %}{{ valeur }}{% endif %}
                        </span>
                        {% set first_secondary_displayed = true %}
                    {% endif %}
                {% endfor %}
            {% else %}
                {# CAS 3 : Toutes les autres listes (principales, onglets). On restaure l'ancien affichage complet. #}
                {% for texte in col_principale.textes_secondaires %}
                    <span class="d-inline-flex align-items-center">
                        {% if texte.icone is defined %}<twig:UX:Icon name="{{ resolve_icon_name(texte.icone) }}" style="width: {{ texte.icone_taille | default('1.1em') }}; height: {{ texte.icone_taille | default('1.1em') }}; margin-right: 4px;" />{% endif %}
                        {{ texte.attribut_prefixe | default('') }}
                        {% set valeur = attribute(entity, texte.attribut_code) %}
                        {% if texte.attribut_type|default('') == 'date' and valeur is not null %}{{ valeur|date('d/m/Y') }}{% elseif texte.attribut_type|default('') == 'text' and texte.attribut_taille_max is defined and texte.attribut_taille_max is not null and valeur is not null and valeur|length > texte.attribut_taille_max %}{{ valeur|slice(0, texte.attribut_taille_max) ~ '...' }}{% else %}{{ valeur }}{% endif %}
                    </span>
                    {% if not loop.last %}<span class="mx-2">{{ col_principale.textes_secondaires_separateurs|default(' &bull; ')|raw }}</span>{% endif %}
                {% endfor %}
            {% endif %}
        </small>
    </td>

    {# Colonnes suivantes : Cellules numériques dynamiques #}
    {# On n'affiche les colonnes numériques que si on n'est PAS dans une collection totalisable de dialogue #}
    {% if not (usage is defined and usage == 'dialog' and totalizableField is defined and totalizableField is not null) %}
        {% for colonne in listeCanvas.colonnes_numeriques %}
            <td class="text-end" style="font-weight: bold; color: #495057;"> {# Gris foncé #}
                <small>
                    {% set valeur_numerique = attribute(entity, colonne.attribut_code) %}
                    {{ colonne.attribut_unité }} {{ valeur_numerique | number_format(2, ',', ' ') }}
                </small>
            </td>
        {% endfor %}
    {% endif %}

    {# NOUVEAU : Colonne pour les actions, uniquement en contexte de dialogue/collection #}
    {% if usage is defined and usage == 'dialog' %}
        <td class="text-end pe-3">
            <div class="list-row-actions-container" data-collection-target="rowActions">
                <button type="button" class="btn btn-sm btn-light btn-icon shadow-sm border-0" title="Modifier" data-action="click->collection#editItem" style="width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                    <twig:UX:Icon name="{{ resolve_icon_name('lucide:edit') }}" style="width: 20px; height: 20px;" class="text-primary"/>
                </button>
                <button type="button" class="btn btn-sm btn-light btn-icon shadow-sm border-0" title="Supprimer" data-action="click->collection#deleteItem" style="width: 30px; height: 30px; padding: 0; display: inline-flex; align-items-center; justify-content: center;">
                    <twig:UX:Icon name="{{ resolve_icon_name('lucide:trash-2') }}" style="width: 20px; height: 20px;" class="text-danger" />
                </button>
            </div>
        </td>
    {% endif %}
</tr>
