{#
    Ce template est le "canvas" d'un formulaire, conçu pour être chargé dynamiquement dans une boîte de dialogue.
 Ce template est le "canvas" d'un formulaire, conçu pour être chargé dynamiquement dans une boîte de dialogue.
    Il est divisé en deux colonnes :

    1. Colonne de gauche (Attributs calculés) :
       - Affiche les valeurs qui ne sont pas directement modifiables dans le formulaire mais qui sont calculées côté serveur.
       - Utilise le contrôleur Stimulus `tooltip` (anciennement `tooltip-manager`) pour afficher des descriptions au survol.
       - Les informations sont tirées de la variable `entityCanvas`.

    2. Colonne de droite (Formulaire) :
       - Affiche le formulaire Symfony (`form`).
       - La disposition des champs est contrôlée par la structure `entityFormCanvas.parametres.form_layout`.
       - Gère un widget spécial pour les collections, identifié par `collection` (anciennement `collection-manager`).
#}
{# On dit à Twig d'utiliser notre thème personnalisé pour ce formulaire #}
{% form_theme form 'themes/_collection_widget.html.twig' %}

{# ========================================================== #}
{# PARTIE 1 : La colonne des attributs calculés (gauche)      #}
{# ========================================================== #}
{% if entityCanvas is defined and entityCanvas.liste is defined and entityCanvas.liste is not empty %}
    <div class="calculated-attributes-column-content">
        <h5 class="column-title">Attributs calculés</h5>
        <ul class="calculated-attributes-list" data-controller="tooltip">
            {% for attr in entityCanvas.liste %}
                {% if attr.type == 'Calcul' %}
                    <li
                        data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                        data-tooltip-content="{{ attr.description|default('Aucune description disponible.') }}"
                    >
                        <span class="attr-label">{{ attr.intitule }} :</span>
                        <span class="attr-value">
                            {% set value = attribute(form.vars.data, attr.code) %}
                            {% if attr.format is defined and attr.format == 'ArrayAssoc' and value is iterable %}
                                {# Si c'est un tableau, on utilise notre nouveau style de tableau #}
                                <table class="attr-table">
                                    <tbody>
                                        {% for key, val in value %}
                                            <tr>
                                                <td class="attr-table-key">{{ key }}</td>
                                                <td class="attr-table-value">{{ val }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% elseif attr.format is defined and attr.format == 'Date' and value is not null and value.timestamp is defined %}
                                {{ value|date('d/m/Y') }}
                            {% else %}
                                {{ value }} {{ attr.unite|default('') }}
                            {% endif %}
                        </span>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
{% endif %}

{# ========================================================== #}
{# PARTIE 2 : La colonne du formulaire (droite)              #}
{# ========================================================== #}
<div class="form-column-content">
    {{ form_start(form) }}
    {% if entityFormCanvas.form_layout is defined and entityFormCanvas.form_layout is not empty %}
        {# Pour chaque ligne définie dans la configuration du layout... #}
        {% for row in entityFormCanvas.form_layout %}
            <div class="row gx-3 {{ (row.couleur_fond is defined and row.couleur_fond) ? 'form-row-colored' : '' }}" style="{{ (row.couleur_fond is defined and row.couleur_fond) ? 'background-color: ' ~ row.couleur_fond ~ ';' : '' }}">
                {% set col_class = 'col-md-' ~ (12 / row.colonnes|length)|round(0, 'floor') %}
                {% for col in row.colonnes %}
                    <div class="{{ col_class }}">
                        {% set champs_list = col.champs is defined ? col.champs : [col] %}
                        {% for field in champs_list %}
                            {% if field is mapping and field.widget is defined and field.widget == 'collection' %}
                                {% set field_code = field.field_code %}
                                {% if form[field_code] is defined %}{{ form_row(form[field_code], {'manager_options': field.options, 'idEntreprise': idEntreprise, 'idInvite': idInvite}) }}{% endif %}
                            {% else %}
                                {% set field_code = (field is mapping and field.field_code is defined) ? field.field_code : field %}
                                {% if form[field_code] is defined %}{{ form_row(form[field_code], {'manager_options': field.options|default({}) }) }}{% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        {{ form_widget(form) }}
    {% endif %}
    {{ form_end(form, {'render_rest': false}) }}
</div>