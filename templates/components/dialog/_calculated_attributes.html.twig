{# templates/components/dialog/_calculated_attributes.html.twig #}

{# On vérifie si le canvas et la liste des attributs existent #}
{% if canvas is defined and canvas.liste is defined and canvas.liste is not empty %}
    <div class="calculated-attributes-column-content">
        <h5 class="column-title">Attributs calculés</h5>
        {# Le contrôleur 'tooltip' gère l'affichage des descriptions au survol #}
        <ul class="calculated-attributes-list" data-controller="tooltip">
            {# On boucle sur tous les champs définis dans le canvas de l'entité #}
            {% for attr in canvas.liste %}
                {# On affiche uniquement les attributs de type 'Calcul' #}
                {% if attr.type == 'Calcul' %}
                    <li
                        data-action="mouseenter->tooltip#show mouseleave->tooltip#hide"
                        data-tooltip-content="{{ attr.description|default('Aucune description disponible.') }}"
                    >
                        <span class="attr-label">{{ attr.intitule }} :</span>
                        <span class="attr-value">
                            {# On récupère dynamiquement la valeur depuis l'objet 'entity' #}
                            {% set value = attribute(entity, attr.code) %}
                            
                            {# Gestion des formats d'affichage spécifiques #}
                            {% if attr.format is defined and attr.format == 'ArrayAssoc' and value is iterable %}
                                {# Formatage pour les tableaux clé-valeur #}
                                <table class="attr-table">
                                    <tbody>
                                        {% for key, val in value %}
                                            <tr>
                                                <td class="attr-table-key">{{ key }}</td>
                                                <td class="attr-table-value">{{ val }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% elseif attr.format is defined and attr.format == 'Date' and value is not null and value.timestamp is defined %}
                                {# Formatage pour les dates #}
                                {{ value|date('d/m/Y') }}
                            {% else %}
                                {# Affichage par défaut #}
                                {{ value }} {{ attr.unite|default('') }}
                            {% endif %}
                        </span>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
{% endif %}
