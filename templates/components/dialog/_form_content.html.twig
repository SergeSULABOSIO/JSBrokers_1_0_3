{# templates/components/dialog/_form_content.html.twig #}
{% form_theme form 'themes/_collection_widget.html.twig' %}
{% set title = isCreationMode
    ? formCanvas.parametres.titre_creation
    : formCanvas.parametres.titre_modification|replace({'%id%': entity.id})
%}

<div class="modal-header">
    <h5 class="modal-title">{{ title }}</h5>
    <button type="button" class="btn-close btn-close-gray" data-action="click->dialog-instance#close"></button>
</div>

<div class="dialog-progress-container">
    <div class="dialog-progress-bar" role="progressbar"></div>
</div>

<div class="modal-body-split">
    {% include 'components/dialog/_calculated_attributes.html.twig' with { entity: entity, canvas: entityCanvas } %}

    <div class="form-column">
        {{ form_start(form) }}
        {% if formCanvas.form_layout is defined and formCanvas.form_layout is not empty %}
            {# Pour chaque ligne définie dans la configuration du layout... #}
            {% for row in formCanvas.form_layout %}
                <div class="row gx-3 {{ (row.couleur_fond is defined and row.couleur_fond) ? 'form-row-colored' : '' }}" style="{{ (row.couleur_fond is defined and row.couleur_fond) ? 'background-color: ' ~ row.couleur_fond ~ ';' : '' }}" data-dialog-instance-target="formRow">
                    {% for col in row.colonnes %}
                        {# On utilise la largeur définie dans le canvas, sinon on divise équitablement #}
                        {% set col_class = col.width is defined ? 'col-md-' ~ col.width : 'col-md-' ~ (12 / row.colonnes|length)|round(0, 'floor') %}

                        {# NOUVEAU : Préparation des attributs pour la visibilité dynamique #}
                        {% set first_field_in_col = col.champs[0] ?? null %}
                        {% set visibility_conditions = (first_field_in_col is mapping and first_field_in_col.visibility_conditions is defined) ? first_field_in_col.visibility_conditions|json_encode : null %}

                        <div class="{{ col_class }}"
                            {% if visibility_conditions %}
                                data-dialog-instance-target="dynamicFieldContainer"
                                data-visibility-conditions-value="{{ visibility_conditions }}"
                            {% endif %}
                        >
                            {% set champs_list = col.champs is defined ? col.champs : [col] %}
                            {% for field in champs_list %}
                                {% if field is mapping and field.widget is defined and field.widget == 'collection' %}
                                    {% set field_code = field.field_code %}
                                    {% if form[field_code] is defined %}{{ form_row(form[field_code], {'manager_options': field.options, 'idEntreprise': idEntreprise, 'idInvite': idInvite}) }}{% endif %}
                                {% else %}
                                    {% set field_code = (field is mapping and field.field_code is defined) ? field.field_code : field %}
                                    {% if form[field_code] is defined %}{{ form_row(form[field_code], {'manager_options': field.options|default({}) }) }}{% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            {{ form_widget(form) }}
        {% endif %}
        {{ form_end(form, {'render_rest': false}) }}
    </div>
</div>

<div class="modal-footer">
    <div class="feedback-container me-auto">
        {% if isCreationMode %}
            <div class="alert alert-info d-flex align-items-center p-2" role="alert" style="font-size: 0.85rem; border-left: 5px solid #0dcaf0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill flex-shrink-0 me-2" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                <div>Les champs de type collection seront éditables après le premier enregistrement.</div>
            </div>
        {% endif %}
    </div>
    <button type="button" class="btn btn-secondary" data-action="click->dialog-instance#close">
        <svg xmlns="http://www.w3.org/2000/svg" width="25px" height="25px" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm3.59-13L12 10.59L8.41 7L7 8.41L10.59 12L7 15.59L8.41 17L12 13.41L15.59 17L17 15.59L13.41 12L17 8.41z"></path></svg>
        <span>Fermer</span>
    </button>
    <button type="button" class="btn btn-primary" data-action="click->dialog-instance#triggerSubmit">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        <span class="button-icon"><svg xmlns="http://www.w3.org/2000/svg" width="23px" height="23px" viewBox="0 0 24 24" fill="currentColor"><path d="M15.004 3h-10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-10L15.004 3zm-9 16V6h8v4h4v9h-12z"></path></svg></span>
        <span class="button-text">Enregistrer</span>
    </button>
</div>
