{#
    Ce template est le conteneur principal pour l'affichage d'une "rubrique" (une liste d'entités).
    Il est piloté par le contrôleur Stimulus `view-manager` (anciennement `list-tabs`).

    Fonctionnement :
    - Le `view-manager` gère la navigation par onglets. L'onglet "Principal" affiche la liste principale.
    - Lorsqu'un élément de la liste principale est sélectionné, il peut créer dynamiquement de nouveaux onglets
      pour afficher les collections liées à cet élément (ex: les contacts d'un client).
    - Il orchestre l'affichage des composants enfants : barre d'outils, barre de recherche, barre de résumé, et la liste elle-même.
#}
<div 
    class="d-flex flex-column h-100"
    data-controller="view-manager"
    data-view-manager-id-entreprise-value="{{ idEntreprise }}"
    data-view-manager-id-invite-value="{{ idInvite }}"
    data-view-manager-server-root-name-value="{{ serverRootName }}"
    data-view-manager-entity-canvas-value='{{ entityCanvas|json_encode|e('html_attr') }}'
>
    {# ================================================================== #}
    {# SECTION 1 : PANNEAU SUPÉRIEUR FIXE (HEADER & OUTILS)             #}
    {# ================================================================== #}
    <div class="sticky-header bg-white shadow-sm">
        <div class="d-flex align-items-center p-2">
            <div class="me-2">
                <twig:UX:Icon 
                    name="{{ entityCanvas.parametres.icone | default('lucide:file-text') }}" 
                    style="width: 40px; height: 40px; color: #343a40;"
                    data-view-manager-target="rubriqueIcon"
                />
            </div>
            <div class="flex-grow-1">
                <div class="rubrique-title" data-view-manager-target="rubriqueName">{{ entityCanvas.parametres.description | default('Rubrique') }}</div>
                <div class="list-tabs-container" data-view-manager-target="tabsContainer">
                    <button class="list-tab active" data-tab-id="principal" data-action="click->view-manager#switchTab">Principal</button>
                </div>
            </div>
        </div>
        <div class="p-2">{{ include("components/_toolbar.html.twig") }}</div>
        <div class="p-2 pt-0">{{ include('components/_search_bar.html.twig', {'entite_nom': entite_nom}) }}</div>
        <div class="p-2 pt-0">{{ include('components/_list_summary.html.twig') }}</div>
        <div class="p-2 small text-muted" data-view-manager-target="display">Prêt.</div>
    </div>

    {# ================================================================== #}
    {# SECTION 2 : ZONE DE CONTENU DYNAMIQUE (LISTES)                     #}
    {# ================================================================== #}
    <div class="flex-grow-1" style="overflow-y: auto;" data-view-manager-target="tabContentContainer">
        <div 
            data-content-id="principal" 
            data-entity-name="{{ entite_nom }}" 
            data-server-root-name="{{ serverRootName }}" 
            data-can-add="true"
        >
            {# On utilise notre nouveau composant générique pour la liste principale #}
            {{ include('components/_generic_list_component.html.twig', {
                'data': data,
                'entite_nom': entite_nom,
                'serverRootName': serverRootName,
                'entityCanvas': entityCanvas,
                'listeCanvas': listeCanvas,
                'entityFormCanvas': entityFormCanvas,
                'numericAttributesAndValues': numericAttributesAndValues,
                'idEntreprise': idEntreprise,
                'idInvite': idInvite,
            }) }}
        </div>
    </div>
    {{ include('components/_context_menu.html.twig') }}
    <div data-controller="dialog-manager"></div>

    {# ================================================================== #}
    {# SECTION 4 : BOÎTE DE DIALOGUE DE RECHERCHE AVANCÉE                 #}
    {# ================================================================== #}
    {# Déplacée ici pour éviter les problèmes de z-index (stacking context) #}
    <div 
        class="modal fade app-dialog" 
        data-search-bar-target="advancedSearchModal" 
        tabindex="-1"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
    >
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <twig:ux:icon name="lucide:sliders-horizontal" class="me-2" style="width: 28px; height: 28px;" />
                        Recherche Avancée
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-action="click->search-bar#cancelAdvancedSearch" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white">
                    <form data-action="keydown.enter->search-bar#submitAdvancedSearch">
                        <div data-search-bar-target="advancedFormContainer" class="form-scrollable-content"></div>
                        <div class="d-flex justify-content-end mt-4 border-top pt-3">
                            <button type="button" class="btn btn-secondary me-2" data-action="click->search-bar#cancelAdvancedSearch">Annuler</button>
                            <button type="button" class="btn btn-primary" data-action="click->search-bar#submitAdvancedSearch">Rechercher</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>